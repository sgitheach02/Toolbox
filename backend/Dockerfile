# Dockerfile Backend Pacha Toolbox - AVEC METASPLOIT R√âEL
FROM python:3.11-slim

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Mise √† jour et outils de base
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    unzip \
    hydra \
    medusa \
    sshpass \
    perl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Installation des outils qui MARCHENT vraiment dans Debian
RUN apt-get update && apt-get install -y \
    nmap \
    tcpdump \
    netcat-openbsd \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Installation de Nikto depuis les SOURCES
RUN cd /opt && \
    git clone https://github.com/sullo/nikto.git && \
    cd nikto && \
    chmod +x program/nikto.pl && \
    ln -s /opt/nikto/program/nikto.pl /usr/local/bin/nikto && \
    nikto -Version

# Installation des d√©pendances Metasploit
RUN apt-get update && apt-get install -y \
    postgresql \
    postgresql-contrib \
    build-essential \
    zlib1g-dev \
    libreadline-dev \
    libssl-dev \
    libpq-dev \
    libsqlite3-dev \
    libpcap-dev \
    openjdk-17-jre-headless \
    sudo \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Cr√©er un utilisateur non-root pour Metasploit
RUN useradd -m -s /bin/bash msf && \
    echo "msf ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Installer Metasploit via le script officiel
RUN curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \
    chmod 755 msfinstall && \
    ./msfinstall && \
    rm msfinstall

# Donner les permissions n√©cessaires
RUN chown -R msf:msf /opt/metasploit-framework || true
RUN chmod +x /usr/bin/msfconsole || true

WORKDIR /app

# D√©pendances Python
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# R√©pertoires
RUN mkdir -p /app/data/reports /app/data/logs /app/data/temp
RUN chown -R msf:msf /app/data

# Code source
COPY . .
RUN chown -R msf:msf /app

# Script de v√©rification
COPY <<EOF /app/check_tools.sh
#!/bin/bash
echo "üîç V√©rification des outils:"
for tool in nmap nikto tcpdump hydra msfconsole; do
  if command -v \$tool >/dev/null 2>&1; then
    echo "‚úÖ \$tool: OK"
  else
    echo "‚ùå \$tool: MANQUANT"
  fi
done
echo "Test Metasploit:"
msfconsole --version || echo "Metasploit install√©, initialisation au runtime"
EOF

RUN chmod +x /app/check_tools.sh

# Test final
RUN /app/check_tools.sh

EXPOSE 5000

# Script de d√©marrage
COPY <<EOF /app/start.sh
#!/bin/bash
set -e
echo "Starting Pacha Toolbox with real Metasploit..."

# D√©marrer PostgreSQL
echo "Starting PostgreSQL..."
service postgresql start
sleep 5

# Initialiser Metasploit DB si n√©cessaire (en tant que user msf)
if [ ! -f /home/msf/.msf4/database.yml ]; then
    echo "Initializing Metasploit database..."
    su - msf -c "msfdb init" || echo "DB init skipped, will use without DB"
fi

# V√©rifier les outils
echo "Checking security tools..."
for tool in nmap nikto hydra tcpdump msfconsole; do
    if command -v \$tool >/dev/null 2>&1; then
        echo "‚úÖ \$tool: Available"
    else
        echo "‚ùå \$tool: Missing"
    fi
done

echo "All tools ready, starting application..."
exec python3 main.py
EOF

RUN chmod +x /app/start.sh

CMD ["/app/start.sh"]